name: Test & Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  go-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

    - name: Run tests with coverage
      run: |
        go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        go tool cover -func=coverage.out

    - name: Generate coverage report
      run: |
        go tool cover -html=coverage.out -o coverage.html
        go tool cover -func=coverage.out | tail -1 | awk '{print "Go Coverage: " $3}' > go-coverage-summary.txt

    - name: Upload Go coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: go
        name: go-coverage
        fail_ci_if_error: false

    - name: Upload Go coverage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: go-coverage
        path: |
          coverage.out
          coverage.html
          go-coverage-summary.txt

  frontend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests with coverage
      run: npm run test:coverage

    - name: Generate coverage summary
      run: |
        npx vitest run --coverage --reporter=json > coverage-report.json || true
        echo "Frontend Coverage: $(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')%" > frontend-coverage-summary.txt

    - name: Upload Frontend coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        directory: ./frontend
        flags: frontend
        name: frontend-coverage
        fail_ci_if_error: false

    - name: Upload frontend coverage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-coverage
        path: |
          frontend/coverage/
          frontend/frontend-coverage-summary.txt

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [go-tests]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build

    - name: Install Go dependencies
      run: go mod download

    - name: Start Go server (background)
      run: |
        export PORT=8080
        export DATABASE_URL=postgres://testuser:testpass@localhost:5432/testdb?sslmode=disable
        export BABEL_ENGINE=mock
        go run . &
        echo $! > server.pid
        sleep 5

    - name: Install Playwright browsers
      working-directory: ./frontend
      run: npx playwright install --with-deps

    - name: Run E2E tests
      working-directory: ./frontend
      run: npm run test:e2e

    - name: Stop Go server
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
        fi

    - name: Upload E2E test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-results
        path: |
          frontend/test-results/
          frontend/playwright-report/

  coverage-comment:
    runs-on: ubuntu-latest
    needs: [go-tests, frontend-tests]
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4

    - name: Download Go coverage
      uses: actions/download-artifact@v3
      with:
        name: go-coverage
        path: ./go-coverage

    - name: Download Frontend coverage
      uses: actions/download-artifact@v3
      with:
        name: frontend-coverage
        path: ./frontend-coverage

    - name: Create coverage comment
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // Read Go coverage
          let goCoverage = 'N/A';
          try {
            goCoverage = fs.readFileSync('./go-coverage/go-coverage-summary.txt', 'utf8').trim();
          } catch (e) {
            console.log('Go coverage not found');
          }
          
          // Read Frontend coverage
          let frontendCoverage = 'N/A';
          try {
            frontendCoverage = fs.readFileSync('./frontend-coverage/frontend-coverage-summary.txt', 'utf8').trim();
          } catch (e) {
            console.log('Frontend coverage not found');
          }
          
          // Create comment body
          const body = `## ðŸ“Š Test Coverage Report
          
          | Component | Coverage |
          |-----------|----------|
          | ðŸ”§ Go Backend | ${goCoverage} |
          | âš›ï¸ Frontend | ${frontendCoverage} |
          
          ### ðŸ“ˆ Coverage Details
          
          **Go Backend Coverage:**
          - Coverage report available in artifacts
          - Unit tests: âœ…
          - Integration tests: âœ…
          
          **Frontend Coverage:**
          - Coverage report available in artifacts  
          - Unit tests: âœ…
          - Component tests: âœ…
          
          ### ðŸš€ Test Results
          - All tests must pass before merging
          - Coverage thresholds enforced
          - E2E tests validate full workflow
          
          _Coverage reports generated automatically by GitHub Actions_ ðŸ¤–
          `;
          
          // Find existing coverage comment
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const existingComment = comments.data.find(comment => 
            comment.body.includes('## ðŸ“Š Test Coverage Report')
          );
          
          if (existingComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: body
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
